### BGP (Border Gateway Protocol) 간단 정리

1. BGP의 역할
   - BGP는 자율 시스템(AS) 간 라우팅을 담당한다.
   - 같은 AS 내에서는 내부 라우팅 프로토콜을 사용하여 경로를 결정하지만, AS 외부로의 경로는 BGP가 관리한다.
   - BGP는 CIDR 형식의 주소 프리픽스(예: 139.16.68/22)로 경로를 표현하고, 가장 좋은 경로를 결정한다.

2. BGP 경로 결정
   - 라우터는 여러 경로를 알 수 있으며, BGP 경로 결정 프로시저를 통해 최적의 경로를 선택한다.
   - BGP는 이웃 AS와 경로 정보를 교환하여 서브넷 프리픽스 정보를 인터넷에 알린다.

3. BGP의 연결
   - 외부 BGP (eBGP): 두 AS 간 연결을 담당.
   - 내부 BGP (iBGP): 같은 AS 내의 라우터 간 연결을 담당.
   - BGP 연결은 TCP 포트 179를 통해 이루어지며, 반영구적인 연결을 통해 라우팅 정보를 교환한다.

4. 라우터 종류
   - 게이트웨이 라우터 (gateway router): 다른 AS와 연결된 AS 경계 라우터.
   - 내부 라우터 (internal router): 자신의 AS 내에서만 연결된 라우터.

### 요약
- BGP는 AS 간 라우팅을 관리하고, eBGP는 다른 AS와의 연결, iBGP는 같은 AS 내 라우터들 간의 경로 정보를 공유한다.
- BGP는 TCP 포트 179를 사용하여 경로 정보를 교환한다.
### 내부 알고리즘과 iBGP의 차이점

| 구분             | 내부 알고리즘 (Internal Routing Algorithm)       | iBGP (Internal BGP)                                |
|------------------|---------------------------------------------------|--------------------------------------------------------|
| 목적         | AS 내부에서 효율적인 경로를 계산하고 데이터 전달 | 외부 경로 정보를 AS 내부 라우터들 간에 공유     |
| 예시         | OSPF, IS-IS, RIP                                 | BGP (Internal BGP)                                     |
| 주요 기능     | AS 내 라우터 간의 로컬 경로 계산               | 외부 경로 정보를 내부 라우터들과 공유           |
| 사용 대상     | AS 내부 네트워크                              | 외부 AS와 연결된 경로를 내부 라우터들과 공유       |
| 경로 결정     | 최단 경로 또는 최적 경로 계산                     | 외부 AS로 가는 최적 경로를 선택하기 위한 정보 공유   |

### 요약
- 내부 알고리즘은 AS 내부 라우팅을 처리한다.
- iBGP는 외부 경로 정보를 AS 내부 라우터들 간에 공유하는 역할을 한다.
- iBGP는 TCP/IP 연결을 사용하여 라우터 간 경로 정보를 주고받기 때문에, 물리적 네트워크 연결과는 관계없이 논리적인 연결을 통해 동작한다.     
따라서 iBGP 연결은 물리적인 링크와 일치할 필요가 없다.

-----

### BGP 경로 선택 과정 (예시 포함)

BGP에서 라우터는 목적지 서브넷에 대해 여러 경로를 알 수 있다. 이때, 라우터는 최고의 경로를 선택해야 하며, 이를 위해 BGP 경로 선택 알고리즘을 사용한다. 아래에서 BGP가 경로를 선택하는 방법을 예시와 함께 쉽게 설명한다.

### 1. 경로 선택의 기준
라우터는 여러 경로 중 가장 좋은 경로를 선택하기 위해 BGP 속성을 사용한다. 경로 선택에 사용되는 주요 속성은 AS-PATH, NEXT-HOP, 그리고 지역 선호도(local preference)이다.     
NEXT-HOP은 BGP 경로 속성 중 하나로, 특정 경로가 시작되는 지점인 라우터 인터페이스의 IP 주소를 나타낸다. 쉽게 말하면, 패킷이 다음에 도달해야 할 라우터의 IP 주소이다.
#### 예시:
- 라우터 1b는 서브넷 x로 가는 두 개의 경로를 알게 된다.
  - 경로 1: AS2를 통해 가는 경로, NEXT-HOP은 라우터 2a.
  - 경로 2: AS3를 통해 가는 경로, NEXT-HOP은 라우터 3d.

### 2. 뜨거운 감자 라우팅 (Hot Potato Routing)
BGP는 자신의 AS에서 최소 비용으로 외부로 데이터를 내보낼 수 있는 경로를 선택한다. 이를 뜨거운 감자 라우팅이라고 한다. 즉, 라우터는 자신의 AS 내부 비용만 고려하고, 최소 비용 경로를 찾아 외부로 내보낸다.

### 3. BGP 경로 선택 알고리즘
BGP는 여러 경로 중 최고의 경로를 선택하는 복잡한 알고리즘을 사용한다. 경로가 여러 개 있을 경우, BGP는 순차적으로 여러 규칙을 적용하여 최적의 경로를 선택한다.

1. 지역 선호도(local preference)가 높은 경로를 선택한다.
2. 지역 선호도가 같으면, AS-PATH 길이가 짧은 경로를 선택한다.
   ### 예시로 쉽게 설명

-  경로 1: AS1 → AS2 → AS3
   - AS-PATH: [AS1, AS2, AS3]
   - AS-PATH 길이: 3 (AS3까지 가는 데 3개의 AS를 거침)

-  경로 2: AS1 → AS4
   - AS-PATH: [AS1, AS4]
   - AS-PATH 길이: 2 (AS4까지 가는 데 2개의 AS만 거침)

### BGP에서 AS-PATH 길이 선택
- BGP는 AS-PATH 길이가 짧은 경로를 더 선호한다. 즉, 경로 2(AS1 → AS4)를 선택

3. 여전히 경로가 여러 개 남으면, 뜨거운 감자 라우팅을 사용하여 최소 비용 경로를 선택한다.

### 4. 최종 경로 선택
BGP가 선택한 경로는 포워딩 테이블에 추가된다. 라우터는 포워딩 테이블을 참고하여, 패킷을 올바른 경로로 전달한다.

### 5. 결론
- BGP는 여러 경로 중 최적의 경로를 선택하기 위해 지역 선호도, AS-PATH 길이, 뜨거운 감자 라우팅 등을 고려한다.
- 경로가 여러 개 있을 경우, BGP는 자신의 AS 내부 비용을 최소화하려는 이기적인 방식으로 경로를 선택한다.
- BGP 경로 선택 알고리즘은 복잡하지만, 최적의 경로를 선택하는 데 중요한 역할을 한다.

이 방식은 라우터가 목적지로 가는 최적 경로를 선택하는 데 중요한 기준이 된다.

---

### BGP와 IP 애니캐스트 (예시와 함께 쉽게 설명)

IP 애니캐스트는 데이터를 가장 가까운 서버로 전송하는 기술이다. 이 기술은 BGP와 결합되어 사용되며, 지리적으로 분산된 서버들 중 사용자에게 가장 가까운 서버로 요청을 보낼 수 있게 도와준다.

### 1. IP 애니캐스트란?
애니캐스트(anycast)는 데이터를 네트워크에 연결된 여러 서버 중 가장 가까운 하나의 서버로만 전송하는 방식이다. 이를 통해 서버들에 복제된 콘텐츠를 사용자에게 가장 빠르게 제공할 수 있다.

#### 예시:
- CDN(Content Delivery Network)에서는 비디오 콘텐츠를 전 세계 여러 서버에 복제해 둔다. 이때 IP 애니캐스트를 사용하면, 사용자가 어떤 나라에서 접속하든 가장 가까운 서버로 비디오를 전송받을 수 있다.

### 2. IP 애니캐스트와 BGP 활용
BGP는 애니캐스트를 구현하는 데 사용될 수 있다. BGP 경로 선택 알고리즘을 통해, 네트워크 라우터는 사용자와 가장 가까운 서버로 데이터를 보내기 위해 다양한 경로를 비교한다.

#### 단계:
1. 서버에 동일한 IP 주소 할당: CDN 사업자는 여러 서버에 동일한 IP 주소를 할당한다.
2. BGP를 통한 경로 전파: 각 서버는 이 IP 주소를 BGP를 사용하여 자신의 위치에 맞게 알려준다.
3. 라우터 경로 선택: 라우터는 BGP 경로 선택 알고리즘을 사용해 가장 가까운 서버로 패킷을 전달한다.

#### 예시:
- 서버 A, B, C가 각각 다른 국가에 위치한 서버들이다. 사용자가 서버 A와 가까운 위치에 있을 때, 라우터는 서버 A로 패킷을 보낸다. 만약 사용자가 서버 B 근처에 있다면, 패킷은 서버 B로 전달된다.

### 3. BGP 라우팅 정책
BGP는 경로 선택 시 AS 간의 라우팅 정책을 우선시한다. 즉, 트래픽의 목적지나 출발지가 특정 AS에 속하는지에 따라 경로를 설정한다.

#### 예시:
- ISP 네트워크 A, B, C가 서로 연결되어 있다. 사용자 네트워크에서 ISP 네트워크로 트래픽을 보낼 때, 각 ISP 네트워크는 자신의 고객만을 위한 경로를 우선적으로 사용한다.

### 4. 라우팅 정책과 상호 협정
BGP 라우팅 정책은 ISP 간 협정에 따라 다르게 설정될 수 있다. 일반적으로, ISP 백본 네트워크를 통해 흐르는 트래픽은 그 ISP의 고객 네트워크를 출발지나 목적지로 해야 한다는 규칙이 있다.

#### 예시:
- ISP B는 ISP A와 연결되어 있으며, A가 W까지 가는 경로 AW를 알게 된다.
- B는 A를 통해 W로 가는 경로를 자기 고객 X에게 알리기 원한다.
- 그러나 C에게 이 경로를 알리지 않겠다. 왜냐하면 B는 A와 C 사이의 트래픽을 처리하지 않으려 하기 때문이다.

### 5. BGP 라우팅과 협정
BGP 경로 알림은 ISP 간 협정을 기반으로 하며, 이는 기밀사항일 수 있다.      
즉, BGP 라우팅은 단순히 최단 경로나 최소 비용을 선택하는 것이 아니라, 각 ISP의 비즈니스 협정에 따라서도 달라질 수 있다.

### 요약:
- IP 애니캐스트는 가장 가까운 서버로 데이터를 전송하는 기술이다.
- BGP는 애니캐스트 경로를 선택하는 데 사용되며, BGP 경로 선택 알고리즘을 통해 가장 가까운 서버를 선택한다.
- BGP 라우팅 정책은 AS 간의 협정에 의해 결정되며, ISP 백본 네트워크를 통한 트래픽 흐름은 고객 네트워크를 우선시하는 경향이 있다.

---

### AS 간 라우팅과 AS 내부 라우팅 프로토콜의 차이

1. 정책
   - AS 간 라우팅은 정책 이슈가 중요하다. 특정 AS에서 시작된 트래픽은 다른 특정 AS를 통과할 수 없으며, 어떤 트래픽을 다른 AS에 전달할지 선택할 수 있어야 한다.
   - AS 내부 라우팅에서는 모든 것이 하나의 관리 체계 하에 있어 정책 문제는 경로 선택에 큰 영향을 미치지 않는다.

2. 확장성
   - AS 간 라우팅에서는 수많은 네트워크를 처리할 수 있는 확장성이 중요하다. BGP는 대규모 네트워크에서 경로 설정을 효율적으로 처리할 수 있다.
   - AS 내부 라우팅에서는 확장성이 중요하지 않다. 하나의 ISP가 너무 커지면 두 개의 AS로 분리하고 그 사이에서 AS 간 라우팅을 할 수 있다.

3. 성능
   - AS 간 라우팅은 정책을 우선시한다. 경로의 성능은 부수적인 관심사에 지나지 않는다.
   - AS 내부 라우팅에서는 성능에 더 중점을 둔다. 경로의 성능 수준을 고려하여 최적의 경로를 선택한다.

### 5.4.6 조각 맞추기: 인터넷 존재 확인하기

1. 회사 설립:
   - 작은 회사를 설립하고, 지역 ISP와 계약하여 인터넷 연결을 설정한다. 회사는 게이트웨이 라우터를 설치하고, ISP는 회사에 IP 주소 범위를 할당한다.

2. 도메인 등록과 DNS:
   - 회사는 도메인 이름을 등록하고, DNS 서버에 해당 도메인 이름과 IP 주소를 등록한다. 이를 통해 사람들이 회사의 웹 서버에 접속할 수 있게 된다.

3. BGP 경로 전파:
   - 회사의 주소 프리픽스는 지역 ISP를 통해 BGP로 전파된다. 다른 ISP들은 BGP를 사용하여 이 경로를 전파하고, 라우터들은 이 주소로 가는 경로를 알게 된다.

4. 인터넷 라우팅:
   - 사용자 앨리스는 DNS 시스템을 통해 회사의 웹 서버 IP 주소를 얻고, 해당 주소로 TCP 연결을 시도한다. 이 데이터그램은 BGP 경로를 통해 라우터를 거쳐 최종 목적지인 웹 서버로 전달된다.

### 요약
- 게이트웨이 라우터는 새로 설립된 회사가 인터넷에 연결하기 위해 반드시 설치해야 하는 장비이다.
- AS 간 라우팅은 정책(비즈니스 및 보안 요구), 확장성(대규모 네트워크 관리), 성능(최적 경로보다 정책 우선)을 고려해야 한다.
- AS 내부 라우팅은 효율성(빠르고 효율적인 경로 계산)과 성능(최단 경로, 빠른 응답)을 중시한다.





