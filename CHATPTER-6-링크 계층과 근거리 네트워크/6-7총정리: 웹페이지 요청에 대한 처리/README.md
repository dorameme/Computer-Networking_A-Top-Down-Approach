
# 네트워크 요청 흐름: 밥의 랩톱에서 [www.google.com](http://www.google.com) 요청까지

## 1. 네트워크 초기화: DHCP, UDP, IP, 그리고 이더넷
![image](https://github.com/user-attachments/assets/910b2afc-1786-4006-b7f4-75964aee39fb)

1. 컴퓨터를 켠다 
2. 아직 ip가 할당안되어있으니 DHCP로 할당한다.
3. ARP가 이 할당된 IP를 내 mac주소와 연결시킨다.
4. 브라우저를 켜서 URL로 구글을 친다.
5. url의 도메인이름을 ip주소로 변경한다.(DNS)
6. 받은 ip주소랑 3way handshake 를 해서 연결한다.
7. 원하는 웹페이지 데이터를 받는다.

### DHCP 요청 생성 (애플리케이션 계층: DHCP, 전송 계층: UDP, 네트워크 계층: IP, 데이터 링크 계층: 이더넷):

   | 출발지                    | 목적지                                |
   | -------------------------- | -------------------------------------- |
   | MAC 주소: (내 맥주소)            | MAC 주소: FF\:FF\:FF\:FF\:FF\:FF(브로드캐스트) |
   | IP 주소: 0.0.0.0(아직  안정해져있음) | IP 주소: 255.255.255.255(브로드캐스트)         |
   | 포트 번호: 68 (DHCP 클라이언트)     | 포트 번호: 67 (DHCP 서버)                    |

   - 밥은 랩톱을 켜고 이더넷 스위치에 연결된 이더넷 케이블을 연결한다.

   - DHCP 요청 메시지를 생성하며, 목적지 포트 67(DHCP 서버)와 출발지 포트 68(DHCP 클라이언트)을 가진 UDP 세그먼트에 담는다.&#x20;

   - 이 과정은 컴퓨터를 켜서 네트워크에 연결할 때마다 실행되며, DHCP 서버는 네트워크 환경에 따라 두 가지 방식으로 동작한다:

     1. 이전 IP 주소 재할당: 장치가 이전에 동일한 네트워크에서 사용했던 IP 주소를 서버가 기억하고 있으면, 동일한 IP를 다시 할당하려 시도한다.
     2. 새로운 IP 주소 요청: 새로운 네트워크에 연결되거나, 이전 IP 주소의 임대 기간이 만료된 경우, 장치는 DHCP 서버에 새 IP 주소를 요청한다.

   - IP 주소가 없는 초기 상태에서는 출발지 IP 주소를 `0.0.0.0`, 목적지 IP 주소를 브로드캐스트 주소 `255.255.255.255`로 설정한다.

   - 이 메시지는 이더넷 프레임에 포함.

   - DHCP 요청은 네트워크에 처음 연결된 장치가 IP 주소를 할당받기 위해 필요한 과정이다. 네트워크 환경에 따라 할당받는 IP 주소가 달라질 수 있다.

     - 예를 들어, 집에서는 `192.168.x.x`와 같은 사설 IP를 할당받고, 카페에서는 카페 네트워크의 DHCP 서버로부터 다른 사설 IP를 받을 수 있다.
     - 이는 네트워크 자원을 효율적으로 관리하고, 장치가 이동하거나 재연결될 때 발생할 수 있는 충돌을 방지하기 위한 시스템이다.

2. DHCP 요청 전송 및 응답 (데이터 링크 계층: 이더넷, 네트워크 계층: IP, 전송 계층: UDP, 애플리케이션 계층: DHCP):

   - 스위치로 프레임이 전송되고, 스위치는 모든 출력 포트로 프레임을 브로드캐스트한다.
   - 라우터는 DHCP 요청 메시지를 수신하여 응답 메시지(DHCP ACK)를 생성하고, 밥의 랩톱에 IP 주소(예: `68.85.2.101`)를 할당한다.
   - DHCP ACK 메시지에는 디폴트 게이트웨이 IP 주소, 서브넷 정보, DNS 서버 주소 등이 포함된다.
   - 이 메시지는 유니캐스트로 밥의 랩톱에 전달된다.

3. 라우팅 테이블 설정 (애플리케이션 계층: DHCP):

   - 밥의 랩톱은 DHCP ACK 메시지를 수신하여 IP 주소, 게이트웨이 주소, DNS 서버 주소를 기록하고 라우팅 테이블에 추가한다.

## 2. DNS 요청: [www.google.com](http://www.google.com) IP 주소 확인

1. DNS 질의 메시지 생성 (애플리케이션 계층: DNS, 전송 계층: UDP):

   - 밥의 랩톱은 DNS 질의 메시지를 생성하며, 질문 부분에 `www.google.com`을 포함한다.
   - 이 메시지는 목적지 포트 53(DNS 서버)로 설정된 UDP 세그먼트에 포함된다.

2. ARP 프로토콜을 통한 MAC 주소 확인 (데이터 링크 계층: ARP):

   - 게이트웨이 라우터로 메시지를 전송하기 위해, 밥의 랩톱은 ARP 프로토콜로 라우터의 MAC 주소를 확인한다.
   - ARP 질의 메시지는 브로드캐스트되고, 게이트웨이 라우터가 응답하여 자신의 MAC 주소를 제공한다.

3. DNS 질의 전송 (데이터 링크 계층: 이더넷, 네트워크 계층: IP, 전송 계층: UDP):

   - DNS 질의 메시지는 목적지 MAC 주소를 게이트웨이 라우터의 MAC 주소로 설정한 후 스위치로 전송된다.
   - 게이트웨이 라우터는 이 메시지를 받아 컴캐스트 네트워크의 DNS 서버로 전달한다.

4. DNS 응답 처리 (애플리케이션 계층: DNS, 전송 계층: UDP, 네트워크 계층: IP):

   - DNS 서버는 `www.google.com`에 대한 IP 주소(예: `64.233.169.105`)를 포함한 응답 메시지를 생성하여 밥의 랩톱으로 보낸다.
   - 밥의 랩톱은 DNS 응답 메시지로부터 IP 주소를 추출한다.

## 3. 웹 요청: TCP와 HTTP

1. TCP 연결 설정 (전송 계층: TCP, 네트워크 계층: IP, 데이터 링크 계층: 이더넷):

   - 밥의 랩톱은 목적지 포트 80(HTTP)을 가진 TCP SYN 세그먼트를 생성한다.
   - 세그먼트는 목적지 IP 주소 `64.233.169.105`를 가진 IP 데이터그램에 포함되며, 이더넷 프레임으로 변환되어 스위치로 전송된다.

2. 라우터를 통한 데이터그램 전달 (네트워크 계층: IP, 데이터 링크 계층: 이더넷):

   - 데이터그램은 학교 네트워크, 컴캐스트 네트워크, 구글 네트워크의 여러 라우터를 통해 전달된다.
   - 라우터의 포워딩 테이블과 BGP 프로토콜을 이용해 데이터그램의 최적 경로가 결정된다.

3. TCP 연결 확립 (전송 계층: TCP):

   - 구글 서버는 TCP SYN 메시지를 수신하여 SYNACK 메시지로 응답한다.
   - 밥의 랩톱은 SYNACK 메시지를 수신한 후 ACK 메시지를 전송하여 TCP 연결을 확립한다.

4. HTTP 요청 전송 (애플리케이션 계층: HTTP, 전송 계층: TCP, 네트워크 계층: IP):

   - 브라우저는 요청된 URL(`www.google.com`)을 포함한 HTTP GET 메시지를 생성하여 TCP 소켓으로 전송한다.
   - 이 메시지는 구글 서버로 전달된다.

5. HTTP 응답 처리 (애플리케이션 계층: HTTP):

   - 구글 서버는 요청된 웹 페이지를 포함한 HTTP 응답 메시지를 생성하여 TCP 소켓을 통해 전송한다.
   - 밥의 랩톱은 응답 메시지를 수신하여 HTML 콘텐츠를 추출하고 브라우저에 출력한다.

---

## 추가 설명 및 비유

1. DHCP 요청과 응답:

   - DHCP 요청은 "새로 이사 온 집에 인터넷을 설치하기 위해 ISP에 요청하는 과정"과 같다. 밥의 랩톱은 자신에게 IP 주소를 할당해 줄 DHCP 서버에 요청을 보낸다.

2. ARP 프로토콜:

   - ARP는 "집 주소를 알고 있지만 초인종을 누를 사람(=MAC 주소)을 찾는 과정"과 비슷하다. IP 주소는 알지만, 실질적인 통신을 위해 MAC 주소를 찾아야 한다.

3. DNS 요청:

   - DNS는 "전화번호부에서 사람의 이름으로 전화번호를 찾는 과정"과 같다. `www.google.com`이라는 이름으로 해당 서버의 IP 주소를 찾는다.

4. TCP 3-way handshake:

   - TCP 연결 과정은 "전화 걸기"에 비유할 수 있다. 첫 번째 메시지(SYN)는 전화를 거는 행위, 두 번째 메시지(SYNACK)는 받는 사람이 응답하는 행위, 세 번째 메시지(ACK)는 통화 연결을 확정짓는 과정이다.

5. HTTP 요청:

   - HTTP GET 요청은 "온라인 쇼핑몰에서 특정 상품을 요청하는 행위"와 비슷하다. 밥의 랩톱은 구글 서버에 원하는 웹 페이지를 요청하고, 서버는 이에 대한 응답으로 HTML 콘텐츠를 제공한다.

