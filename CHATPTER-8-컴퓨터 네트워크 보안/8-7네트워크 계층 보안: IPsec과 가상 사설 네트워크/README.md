### 8.7 네트워크 계층 보안: IPsec과 가상 사설 네트워크

IPsec은 네트워크 계층의 보안을 제공하는 IP 보안 프로토콜이다.

#### IPsec(아이피섹) 특징

- 네트워크 계층에서 호스트나 라우터 같은 두 개체 간의 IP 데이터그램을 보호한다.
- 데이터그램의 페이로드 부분을 암호화하여 TCP 세그먼트 등이 암호화된다.
- 기밀성을 제공하며, 출발지 인증, 데이터 무결성, 재생 공격 방지 같은 보안 서비스를 제공한다.

#### 8.7.1 IPsec과 가상 사설 네트워크

사설 네트워크

- 흩어져 있는 기관들은 호스트와 서버 간 데이터를 기밀성을 유지하며 안전하게 전송하기 위해 독립된 네트워크를 설치한다.
- 공공 인터넷과 완전히 분리된 라우터, 링크, DNS 시스템을 포함한다.
- 물리적 네트워크 설치는 높은 유지 비용이 든다.

가상 사설 네트워크 (VPN)

- 오늘날에는 공공 인터넷 상에 VPN을 설치하여 사설 네트워크의 역할을 대체한다.
- 기관의 사무실 간 트래픽은 공공 인터넷을 통해 암호화되어 전송된다.
- VPN을 통해 유지 비용을 절감하며 안전한 데이터 전송이 가능하다.

VPN 데이터그램 처리

- 공공 인터넷을 통과하지 않을 때는 평범한 IPv4 데이터그램을 사용한다.
- 공공 인터넷을 통과할 때는 IPv4 데이터그램이 IPsec 데이터그램으로 변환되어 암호화된다.
- 특정 경우에는 IPv4 데이터그램과 IPsec 데이터그램이 모두 전송되기도 한다. 예를 들어, 보안이 필요 없는 일반 웹 트래픽은 IPv4 데이터그램으로 전송되고, 보안이 요구되는 데이터는 IPsec 데이터그램으로 처리된다.
- IPsec 데이터그램은 IPv4 헤더를 포함하며 공공 인터넷에서 전달 가능하다.

#### 8.7.2 AH와 ESP 프로토콜
AH와 ESP 프로토콜은 IPsec의 일부로 사용
| 프로토콜 | 제공 기능                   | 기밀성 여부  |
| ---- | ----------------------- | ------- |
| AH   | 출발지 인증, 데이터 무결성 제공      | 제공하지 않음 |
| ESP  | 출발지 인증, 데이터 무결성, 기밀성 제공 | 제공      |


1. AH (Authentication Header) 에이에이치:
   - IPsec 데이터그램의 인증 및 무결성을 보장한다.
   - 데이터의 기밀성을 제공하지 않으며, 주로 데이터가 변조되지 않았는지 확인하는 데 사용된다.
   - 예: 데이터의 출발지를 확인하고 내용이 변하지 않았음을 보장하지만, 내용 자체는 암호화되지 않는다.

2. ESP (Encapsulating Security Payload) 이에스피:
   - IPsec 데이터그램의 인증, 무결성, 그리고 기밀성을 제공한다.
   - 데이터를 암호화하여 제3자가 내용을 볼 수 없도록 하며, 인증과 무결성도 함께 보장한다.
   - 예: 금융 거래 데이터와 같이 민감한 데이터를 암호화하고, 변조 여부를 확인하는 데 사용된다.

#### 8.7.3 SA (Security Association)

SA 개념

- SA는 네트워크 계층에서 논리적 연결을 설정하며 IPsec 데이터그램 전송을 위한 필수 요소이다.

SA 특징

- 단방향으로 설계되어 있어 송신과 수신 시 각각 별도의 SA가 필요하다.
- 기관 내에 호스트가 n개, 라우터가 m개라면 총 2n + 2m개의 SA가 필요하다.

SA 상태 정보

- 32비트 SPI (Security Parameters Index)
- SA 시작점 및 최종점의 인터페이스 주소
- 암호화 타입 (예: AES, DES)
- 암호화 키
- 무결성 검사 타입 (예: MD5, SHA)
- 인증 키

SA 데이터 관리

- 모든 SA 상태 정보는 SAD (Security Association Database)에 저장된다.

#### 8.7.4 IPsec 데이터그램

데이터그램 변환 과정

1. 원본 IPv4 데이터그램 뒤에 ESP 트레일러를 추가한다.
   - ESP 트레일러는 패딩, 패딩 길이, 다음 헤더 필드로 구성된다.
2. SA에 지정된 알고리즘과 키를 이용하여 데이터를 암호화한다.
3. 암호화된 데이터 앞에 ESP 헤더를 추가한다.
   - ESP 헤더에는 SPI와 순서 번호가 포함된다.
4. 새로운 IPv4 헤더를 생성하여 암호화된 데이터를 전달한다.

데이터그램 전달 과정

1. 수신 라우터는 IPsec ESP 프로토콜을 적용해야 함을 확인한다.
2. SPI를 사용하여 데이터그램이 어느 SA에 속해 있는지 확인한다.
3. MAC을 검증하고 데이터가 변조되지 않았는지 확인한다.
4. 순서 번호를 검사하여 재생 공격을 방지한다.
5. 복호화 후 원래의 IPv4 데이터그램을 최종 목적지로 전달한다.

SPD (Security Policy Database)

- 데이터그램 처리 여부와 관련 SA를 결정한다.
- SPD는 도착한 데이터그램에 대해 "무엇을 할지"를 알려주고, SAD는 "어떻게 할지"를 알려준다.

#### 8.7.5 IKE: IPsec에서의 키 관리

IKE 개념

- IKE (Internet Key Exchange)는 SA 생성 및 키 관리를 자동화하는 프로토콜이다.
- IPsec SA의 세션 키를 안전하게 교환하기 위해 사용된다.

IKE 단계

1. 첫 번째 단계: IKE SA 설립
   - 디피-헬만 알고리즘을 사용하여 IKE SA를 생성한다.
   - 암호화 및 인증 키가 설립되며, 주 비밀키가 생성된다.
   - IPsec SA에 사용될 암호화 및 인증 알고리즘을 협의한다.
2. 두 번째 단계: IPsec SA 설립
   - 양방향 SA를 생성하며 각각의 세션 키가 생성된다.
   - 이후 보안 데이터그램 전송이 가능해진다.

IKE의 역할

- 두 IPsec 개체는 공개키가 포함된 인증서를 사용한다.
- 인증서를 교환하여 인증 및 암호화 알고리즘에 대해 협상한다.
- 보안 데이터그램 전송을 위해 세션 키를 생성한다.

---
### MAC
데이터 검증에 사용되는 MAC은 **Message Authentication Code**의 약자로, 데이터의 무결성과 인증을 확인하는 데 사용된다.    
MAC은 암호화된 해시 값을 생성하여 데이터가 변조되지 않았음을 보장하며, 주로 다음과 같은 방식으로 사용된다:   

1. **입력 데이터와 키를 사용하여 MAC 생성**:
   - 송신자는 데이터와 비밀 키를 사용해 MAC 값을 생성하고 이를 데이터와 함께 전송한다.

2. **수신자가 동일한 키로 MAC 값 검증**:
   - 수신자는 받은 데이터를 동일한 키로 MAC을 생성하고, 송신된 MAC 값과 비교한다.
   - 값이 일치하면 데이터가 변조되지 않았음을 확인한다.

**비유**: MAC은 데이터에 붙이는 **보안 봉인**과 같다. 데이터가 전송 중에 변경되었다면, 봉인이 훼손되었다는 것을 쉽게 확인할 수 있다.

**예시**:
- 알고리즘: HMAC (Hash-based Message Authentication Code), SHA-256과 같은 해시 함수와 키를 결합하여 MAC을 생성한다.
- 사용 사례: IPsec에서 MAC을 사용하여 데이터그램의 무결성을 보장한다.

